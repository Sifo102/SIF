name: RDP 20 Days
on:
  workflow_dispatch:

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - name: Configure Core RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxConnectionTime" -Value 0xFFFFFFFF -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxDisconnectionTime" -Value 0xFFFFFFFF -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxIdleTime" -Value 0xFFFFFFFF -Force
          
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force

      - name: Disable Sleep and Power Saving
        run: |
          powercfg -change -standby-timeout-ac 0
          powercfg -change -hibernate-timeout-ac 0
          powercfg -change -monitor-timeout-ac 0
          powercfg -change -disk-timeout-ac 0
          
          powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c

      - name: Create RDP User
        run: |
          $password = "admin@123"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          Remove-LocalUser -Name "TOOLBOXLAP" -ErrorAction SilentlyContinue
          New-LocalUser -Name "TOOLBOXLAP" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "TOOLBOXLAP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "TOOLBOXLAP"
          Set-LocalUser -Name "TOOLBOXLAP" -PasswordNeverExpires $true
          echo "RDP_CREDS=TOOLBOXLAP:$password" >> $env:GITHUB_ENV

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force
          Start-Sleep -Seconds 10

      - name: Start Tailscale with Persistent Settings
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=rdp-20days --accept-routes --accept-dns --reset
          
          # استخدام tagged nodes لمنع المصادقة المتكررة
          & "$env:ProgramFiles\Tailscale\tailscale.exe" set --tag=rdp-persistent
          
          $tsIP = $null
          for ($i = 1; $i -le 30; $i++) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              if ($tsIP) { break }
              Start-Sleep -Seconds 5
          }
          
          if (-not $tsIP) {
              # محاولة بديلة للحصول على IP
              $tsStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json | ConvertFrom-Json
              $tsIP = $tsStatus.Self.TailscaleIPs[0]
          }
          
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "Tailscale IP: $tsIP"

      - name: Disable Windows Updates
        run: |
          Stop-Service -Name "wuauserv" -Force
          Set-Service -Name "wuauserv" -StartupType Disabled
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" -Name "NoAutoUpdate" -Value 1 -Force

      - name: Create Persistent Service
        run: |
          # إنشاء سكريبت خدمة للحفاظ على RDP
          $serviceScript = @"
          `$startTime = Get-Date
          `$endTime = `$startTime.AddDays(20)
          `$checkCount = 0
          
          while ((Get-Date) -lt `$endTime) {
              `$remaining = `$endTime - (Get-Date)
              `$days = [math]::Round(`$remaining.TotalDays, 1)
              
              # تسجيل الحالة كل ساعة
              if (`$checkCount % 12 -eq 0) {
                  Add-Content -Path "C:\rdp-status.log" -Value "[`$(Get-Date)] RDP Active - `$days days remaining"
              }
              
              # التحقق من خدمات RDP
              `$termservice = Get-Service -Name 'TermService' -ErrorAction SilentlyContinue
              if (`$termservice.Status -ne 'Running') {
                  Start-Service -Name 'TermService' -Force
                  Add-Content -Path "C:\rdp-status.log" -Value "[`$(Get-Date)] Restarted TermService"
              }
              
              # التحقق من Tailscale كل 30 دقيقة
              if (`$checkCount % 6 -eq 0) {
                  try {
                      `$tsIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
                      if (-not `$tsIP) {
                          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --reset
                          Add-Content -Path "C:\rdp-status.log" -Value "[`$(Get-Date)] Restarted Tailscale"
                      }
                  } catch {
                      Add-Content -Path "C:\rdp-status.log" -Value "[`$(Get-Date)] Tailscale Error: `$_"
                  }
              }
              
              `$checkCount++
              Start-Sleep -Seconds 300
          }
          Add-Content -Path "C:\rdp-status.log" -Value "[`$(Get-Date)] 20-day period completed"
"@
          
          Set-Content -Path "C:\keep-rdp-alive.ps1" -Value $serviceScript
          
          # إنشاء مهمة مجدولة لتشغيل السكريبت
          $action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-WindowStyle Hidden -File C:\keep-rdp-alive.ps1"
          $trigger = New-ScheduledTaskTrigger -AtStartup
          $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable -RunOnlyIfNetworkAvailable:$false
          Register-ScheduledTask -TaskName "KeepRDPAlive" -Action $action -Trigger $trigger -Settings $settings -RunLevel Highest -Force

      - name: Start Persistent Service and Show Info
        run: |
          # بدء الخدمة
          Start-ScheduledTask -TaskName "KeepRDPAlive"
          
          # الانتظار قليلاً ثم الحصول على IP النهائي
          Start-Sleep -Seconds 10
          $finalIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          if (-not $finalIP) {
              $finalIP = $env:TAILSCALE_IP
          }
          
          Write-Host "=========================================="
          Write-Host "=== RDP 20 DAYS - READY ==="
          Write-Host "IP Address: $finalIP"
          Write-Host "Username: TOOLBOXLAP"
          Write-Host "Password: admin@123"
          Write-Host "=========================================="
          Write-Host "System will remain active for 20 days"
          Write-Host "Start Time: $(Get-Date)"
          Write-Host "End Time: $((Get-Date).AddDays(20))"
          Write-Host "=========================================="
          
          # تشغيل السكريبت مباشرة أيضاً
          Start-Process PowerShell.exe -ArgumentList "-WindowStyle Hidden -File C:\keep-rdp-alive.ps1" -WindowStyle Hidden

  monitor-rdp:
    runs-on: windows-latest
    needs: setup-rdp
    timeout-minutes: 28800  # 20 يوم
    steps:
      - name: Wait and Monitor
        run: |
          $startTime = Get-Date
          $endTime = $startTime.AddDays(20)
          
          while ((Get-Date) -lt $endTime) {
              $remaining = $endTime - (Get-Date)
              $days = [math]::Round($remaining.TotalDays, 1)
              $hours = [math]::Round($remaining.TotalHours, 1)
              
              Write-Host "[$(Get-Date)] RDP Session Active - $days days ($hours hours) remaining"
              
              # التحقق من السجلات إذا كانت متاحة
              try {
                  if (Test-Path "C:\rdp-status.log") {
                      $lastLog = Get-Content "C:\rdp-status.log" -Tail 1
                      Write-Host "Last service log: $lastLog"
                  }
              } catch {
                  # تجاهل أخطاء القراءة
              }
              
              Start-Sleep -Seconds 300  # 5 دقائق
          }
          
          Write-Host "20-day RDP session completed successfully at $(Get-Date)"
