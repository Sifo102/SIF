name: RDP
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'  # ÙŠØ¹ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙƒÙ„ 5 Ø³Ø§Ø¹Ø§Øª

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 350  # 5 Ø³Ø§Ø¹Ø§Øª Ùˆ50 Ø¯Ù‚ÙŠÙ‚Ø©

    steps:
    - name: Configure Permanent RDP
      run: |
        Write-Host "ğŸ”„ Configuring Permanent RDP..."
        
        # ØªÙ…ÙƒÙŠÙ† RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
        
        # Ù…Ù†Ø¹ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxConnectionTime" -Value 2147483647 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxDisconnectionTime" -Value 2147483647 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxIdleTime" -Value 2147483647 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "KeepAliveTimeout" -Value 2147483647 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "KeepAliveInterval" -Value 2147483647 -Force
        
        # Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ
        netsh advfirewall firewall add rule name="RDP-Permanent" dir=in action=allow protocol=TCP localport=3389
        
        # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©
        Restart-Service -Name TermService -Force
        Write-Host "âœ… RDP configured permanently"

    - name: Disable All Power Management
      run: |
        Write-Host "ğŸ”Œ Disabling all power management..."
        
        # ØªØ¹Ø·ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø§Ù‚Ø©
        powercfg -change -standby-timeout-ac 0
        powercfg -change -hibernate-timeout-ac 0
        powercfg -change -monitor-timeout-ac 0
        powercfg -change -disk-timeout-ac 0
        powercfg -h off
        powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        
        # ØªØ¹Ø·ÙŠÙ„ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Power" -Name "HibernateEnabled" -Value 0 -Force
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Power" -Name "HiberbootEnabled" -Value 0 -Force
        
        Write-Host "âœ… Power management completely disabled"

    - name: Create Permanent User
      run: |
        Write-Host "ğŸ‘¤ Creating permanent user..."
        $username = "TOOLBOXLAP"
        $password = "admin@123"
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        Remove-LocalUser -Name $username -ErrorAction SilentlyContinue
        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
        New-LocalUser -Name $username -Password $securePassword -AccountNeverExpires
        
        # Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        Add-LocalGroupMember -Group "Administrators" -Member $username
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
        Set-LocalUser -Name $username -PasswordNeverExpires $true
        net accounts /maxpwage:unlimited
        
        echo "RDP_USER=$username" >> $env:GITHUB_ENV
        echo "RDP_PASS=$password" >> $env:GITHUB_ENV
        Write-Host "âœ… Permanent user created"

    - name: Install Tailscale
      run: |
        Write-Host "ğŸ“¦ Installing Tailscale..."
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        
        Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
        Start-Process msiexec.exe -Wait -ArgumentList @(
          "/i",
          "`"$installerPath`"",
          "/quiet",
          "/norestart"
        )
        Remove-Item $installerPath -Force
        Start-Sleep -Seconds 15
        Write-Host "âœ… Tailscale installed"

    - name: Setup Tailscale with Persistent Auth
      run: |
        Write-Host "ğŸ”— Setting up Tailscale with persistent authentication..."
        
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ù…Ø¶ÙŠÙ Ø«Ø§Ø¨Øª Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù†ÙØ³ IP
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --hostname=permanent-rdp-static --accept-routes --accept-dns --reset --operator-current-user
        
        Write-Host "â³ Waiting for authentication..."
        Write-Host "ğŸŒ Please visit the URL above to authenticate within 10 minutes..."
        
        # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
        $tsIP = $null
        for ($i = 1; $i -le 120; $i++) {
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            if ($tsIP) {
                echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
                Write-Host "âœ… Tailscale IP: $tsIP"
                
                # Ø­ÙØ¸ Ø§Ù„IP Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
                Set-Content -Path "C:\tailscale-ip.txt" -Value $tsIP
                break
            }
            
            if ($i % 10 -eq 0) {
                $remaining = 120 - $i
                Write-Host "â³ Waiting... $remaining seconds remaining"
            }
            Start-Sleep -Seconds 5
        }
        
        if (-not $tsIP) {
            Write-Host "âŒ Authentication timeout - Please run again"
            exit 1
        }

    - name: Disable All Interruptions
      run: |
        Write-Host "ğŸš« Disabling all interruptions..."
        
        # ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
        $services = @("wuauserv", "UsoSvc", "WaaSMedicSvc", "BITS", "DoSvc", "WinDefend", "WdNisSvc")
        foreach ($service in $services) {
            Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
            Set-Service -Name $service -StartupType Disabled -ErrorAction SilentlyContinue
        }
        
        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" -Name "NoAutoUpdate" -Value 1 -Force
        Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" -Name "NoAutoRebootWithLoggedOnUsers" -Value 1 -Force
        Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" -Name "AUOptions" -Value 1 -Force
        
        Write-Host "âœ… All interruptions disabled"

    - name: Configure Network Stability
      run: |
        Write-Host "ğŸŒ Configuring network stability..."
        
        # ØªØ­Ø³ÙŠÙ† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª TCP
        netsh int tcp set global autotuninglevel=normal
        netsh int tcp set global rss=enabled
        netsh int tcp set global chimney=enabled
        
        Write-Host "âœ… Network stability configured"

    - name: Create Auto-Recovery System
      run: |
        Write-Host "ğŸ”§ Creating auto-recovery system..."
        
        $recoveryScript = @'
# Auto-Recovery System for Permanent RDP
$logPath = "C:\rdp-auto-recovery.log"
$sessionStart = Get-Date
$sessionEnd = $sessionStart.AddMinutes(350) # 5 hours 50 minutes

function Write-RecoveryLog {
    param([string]$Message)
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logEntry = "[$timestamp] $Message"
    Add-Content -Path $logPath -Value $logEntry
}

Write-RecoveryLog "=== AUTO-RECOVERY SYSTEM STARTED ==="
Write-RecoveryLog "Session Start: $sessionStart"
Write-RecoveryLog "Session End: $sessionEnd"

$checkCount = 0
while ((Get-Date) -lt $sessionEnd) {
    $remaining = $sessionEnd - (Get-Date)
    $minutes = [math]::Round($remaining.TotalMinutes, 0)
    
    # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©
    if ($checkCount % 6 -eq 0) {
        Write-RecoveryLog "System Active - $minutes minutes remaining"
    }
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† RDP ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚
    if ($checkCount % 2 -eq 0) {
        $rdpService = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
        if ($rdpService.Status -ne "Running") {
            Write-RecoveryLog "RDP Service stopped - Auto-restarting"
            Start-Service -Name "TermService" -Force
        }
    }
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Tailscale ÙƒÙ„ 15 Ø¯Ù‚ÙŠÙ‚Ø©
    if ($checkCount % 3 -eq 0) {
        try {
            $currentIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
            $savedIP = Get-Content "C:\tailscale-ip.txt" -ErrorAction SilentlyContinue
            
            if (-not $currentIP) {
                Write-RecoveryLog "Tailscale disconnected - Auto-reconnecting"
                & "C:\Program Files\Tailscale\tailscale.exe" up --reset
            } elseif ($savedIP -and $currentIP -ne $savedIP) {
                Write-RecoveryLog "IP changed from $savedIP to $currentIP - Restoring"
                & "C:\Program Files\Tailscale\tailscale.exe" up --hostname=permanent-rdp-static --reset
                Set-Content -Path "C:\tailscale-ip.txt" -Value $currentIP
            }
        } catch {
            Write-RecoveryLog "Tailscale recovery error"
        }
    }
    
    $checkCount++
    Start-Sleep -Seconds 300 # 5 Ø¯Ù‚Ø§Ø¦Ù‚
}

Write-RecoveryLog "=== SESSION COMPLETED - AUTO-RENEWING ==="
'@

        Set-Content -Path "C:\rdp-auto-recovery.ps1" -Value $recoveryScript
        
        # Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
        Start-Process PowerShell.exe -ArgumentList "-WindowStyle Hidden -File C:\rdp-auto-recovery.ps1" -WindowStyle Hidden
        
        Write-Host "âœ… Auto-recovery system started"

    - name: Test RDP Connection
      run: |
        Write-Host "ğŸ” Testing RDP connection..."
        if ($env:TAILSCALE_IP) {
            $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -InformationLevel Quiet
            if ($testResult) {
                Write-Host "âœ… RDP Connection: SUCCESS"
            } else {
                Write-Host "âš ï¸ RDP Connection: Port check failed but continuing"
            }
        }

    - name: Maintain Continuous Operation
      run: |
        Write-Host ""
        Write-Host "========================================================"
        Write-Host "ğŸš€ PERMANENT RDP - CONTINUOUS OPERATION"
        Write-Host "========================================================"
        Write-Host "ğŸŒ IP Address: $env:TAILSCALE_IP"
        Write-Host "ğŸ‘¤ Username: $env:RDP_USER"
        Write-Host "ğŸ”‘ Password: $env:RDP_PASS"
        Write-Host ""
        Write-Host "â° Operation: CONTINUOUS"
        Write-Host "ğŸ”„ Auto-renewal: Every 5 hours"
        Write-Host "ğŸ• Start Time: $(Get-Date)"
        Write-Host "ğŸ“… Next Renewal: $((Get-Date).AddMinutes(350))"
        Write-Host ""
        Write-Host "ğŸ”’ Guaranteed Features:"
        Write-Host "  â€¢ Continuous Operation"
        Write-Host "  â€¢ Static IP Address"
        Write-Host "  â€¢ One-Time Authentication"
        Write-Host "  â€¢ Auto-Recovery System"
        Write-Host "  â€¢ No Timeouts"
        Write-Host "  â€¢ No Interruptions"
        Write-Host "========================================================"
        Write-Host ""

        # Ø§Ù„Ø¨Ù‚Ø§Ø¡ Ù†Ø´Ø·Ø§Ù‹ Ù„Ù…Ø¯Ø© 5 Ø³Ø§Ø¹Ø§Øª Ùˆ50 Ø¯Ù‚ÙŠÙ‚Ø©
        $totalMinutes = 350
        $minutesElapsed = 0
        
        while ($minutesElapsed -lt $totalMinutes) {
            $remainingMinutes = $totalMinutes - $minutesElapsed
            $hours = [math]::Floor($remainingMinutes / 60)
            $minutes = $remainingMinutes % 60
            
            # Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©
            if ($minutesElapsed % 30 -eq 0) {
                Write-Host "[$(Get-Date)] Permanent RDP Active - $hours}h $minutes}m until renewal"
                
                # Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                try {
                    if (Test-Path "C:\rdp-auto-recovery.log") {
                        $lastLog = Get-Content "C:\rdp-auto-recovery.log" -Tail 1 -ErrorAction SilentlyContinue
                        if ($lastLog) {
                            Write-Host "Recovery System: $lastLog"
                        }
                    }
                } catch {
                    # ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
                }
            }
            
            # ÙØ­Øµ Ø´Ø§Ù…Ù„ ÙƒÙ„ Ø³Ø§Ø¹Ø©
            if ($minutesElapsed % 60 -eq 0) {
                Write-Host "ğŸ” Performing health check..."
                
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† RDP
                $rdpService = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
                if ($rdpService.Status -ne "Running") {
                    Write-Host "ğŸ”„ Restarting RDP Service..."
                    Start-Service -Name "TermService" -Force
                }
                
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Tailscale ÙˆØ§Ø³ØªÙ‚Ø±Ø§Ø± IP
                try {
                    $currentIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                    $savedIP = Get-Content "C:\tailscale-ip.txt" -ErrorAction SilentlyContinue
                    
                    if ($currentIP -and $savedIP -and $currentIP -eq $savedIP) {
                        Write-Host "âœ… IP Stable: $currentIP"
                    } else {
                        Write-Host "ğŸ”„ Restoring original IP..."
                        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --hostname=permanent-rdp-static --reset
                        if ($currentIP) {
                            Set-Content -Path "C:\tailscale-ip.txt" -Value $currentIP
                        }
                    }
                } catch {
                    Write-Host "âš ï¸ IP check error"
                }
                
                Write-Host "âœ… Health check completed"
            }
            
            $minutesElapsed += 5
            Start-Sleep -Seconds 300  # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 5 Ø¯Ù‚Ø§Ø¦Ù‚
        }
        
        Write-Host "ğŸ”„ Auto-renewal in progress..."
        Write-Host "âœ… Session completed successfully - Renewing..."
