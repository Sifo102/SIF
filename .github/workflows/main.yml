name: RDP 30 Days
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'  # ÙŠØ¹ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙƒÙ„ 5 Ø³Ø§Ø¹Ø§Øª

jobs:
  rdp-30days:
    runs-on: windows-latest
    timeout-minutes: 350  # 5 Ø³Ø§Ø¹Ø§Øª Ùˆ50 Ø¯Ù‚ÙŠÙ‚Ø©

    steps:
    - name: Configure Permanent RDP
      run: |
        Write-Host "ğŸ”„ Configuring Permanent RDP Settings..."
        
        # ØªÙ…ÙƒÙŠÙ† RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
        
        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù…Ù†Ø¹ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxConnectionTime" -Value 2147483647 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxDisconnectionTime" -Value 2147483647 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxIdleTime" -Value 2147483647 -Force
        
        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯Ø§Ø¦Ù…Ø©
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "KeepAliveTimeout" -Value 2147483647 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "KeepAliveInterval" -Value 2147483647 -Force
        
        # Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ
        netsh advfirewall firewall add rule name="RDP-Permanent" dir=in action=allow protocol=TCP localport=3389
        
        # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©
        Restart-Service -Name TermService -Force
        Write-Host "âœ… RDP configured for 30 days operation"

    - name: Disable All Power and Sleep Features
      run: |
        Write-Host "ğŸ”Œ Disabling all power management..."
        
        # ØªØ¹Ø·ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø§Ù‚Ø©
        powercfg -change -standby-timeout-ac 0
        powercfg -change -hibernate-timeout-ac 0
        powercfg -change -monitor-timeout-ac 0
        powercfg -change -disk-timeout-ac 0
        
        # ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø³Ø¨Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
        powercfg -h off
        
        # ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù„ÙŠ
        powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        
        # ØªØ¹Ø·ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø§Ù‚Ø© ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Power" -Name "HibernateEnabled" -Value 0 -Force
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Power" -Name "HiberbootEnabled" -Value 0 -Force
        
        Write-Host "âœ… Power management completely disabled"

    - name: Create Permanent User Account
      run: |
        Write-Host "ğŸ‘¤ Creating permanent user account..."
        $username = "PERMANENT"
        $password = "admin@123"
        
        # Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙˆØ¥Ù†Ø´Ø§Ø¤Ù‡ Ø¬Ø¯ÙŠØ¯
        Remove-LocalUser -Name $username -ErrorAction SilentlyContinue
        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
        New-LocalUser -Name $username -Password $securePassword -AccountNeverExpires
        
        # Ù…Ù†Ø­ ÙƒØ§ÙØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        Add-LocalGroupMember -Group "Administrators" -Member $username
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
        Add-LocalGroupMember -Group "Users" -Member $username
        
        # ØªØ¹Ø·ÙŠÙ„ Ø§Ù†ØªÙ‡Ø§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        Set-LocalUser -Name $username -PasswordNeverExpires $true
        
        # Ù…Ù†Ø¹ Ù‚ÙÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨
        net accounts /maxpwage:unlimited
        
        echo "RDP_USER=$username" >> $env:GITHUB_ENV
        echo "RDP_PASS=$password" >> $env:GITHUB_ENV
        Write-Host "âœ… Permanent user account created"

    - name: Install Tailscale with Static Configuration
      run: |
        Write-Host "ğŸ“¦ Installing Tailscale..."
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        
        # ØªØ­Ù…ÙŠÙ„ ÙˆØªØ«Ø¨ÙŠØª Tailscale
        Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
        Start-Process msiexec.exe -Wait -ArgumentList @(
          "/i",
          "`"$installerPath`"",
          "/quiet",
          "/norestart"
        )
        Remove-Item $installerPath -Force
        
        # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„ØªØ«Ø¨ÙŠØª
        Start-Sleep -Seconds 15
        Write-Host "âœ… Tailscale installed successfully"

    - name: Setup Manual Tailscale Authentication
      run: |
        Write-Host "ğŸ”— Setting up Tailscale connection..."
        
        # ØªØ´ØºÙŠÙ„ Tailscale Ø¨Ø¯ÙˆÙ† Ù…ÙØªØ§Ø­ Ù…ØµØ§Ø¯Ù‚Ø© (ÙŠØ¯ÙˆÙŠ)
        Write-Host "ğŸ“ Please authenticate manually via the URL below:"
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --hostname=permanent-rdp-30d --accept-routes --accept-dns --reset
        
        # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
        Write-Host "â³ Waiting for manual authentication..."
        Write-Host "ğŸŒ Please visit the URL above to authenticate"
        Write-Host "â° You have 5 minutes to complete authentication..."
        
        # Ø¥Ø¹Ø·Ø§Ø¡ ÙˆÙ‚Øª Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
        $authWaitTime = 300  # 5 Ø¯Ù‚Ø§Ø¦Ù‚
        $tsIP = $null
        
        for ($i = 0; $i -lt $authWaitTime; $i++) {
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            if ($tsIP) {
                echo "RDP_IP=$tsIP" >> $env:GITHUB_ENV
                Write-Host "âœ… Tailscale IP obtained: $tsIP"
                break
            }
            
            if ($i % 30 -eq 0) {  # ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
                $remaining = $authWaitTime - $i
                Write-Host "â³ Still waiting... $remaining seconds remaining"
            }
            
            Start-Sleep -Seconds 1
        }
        
        if (-not $tsIP) {
            Write-Host "âŒ Manual authentication timeout - Please run again and authenticate quickly"
            exit 1
        }

    - name: Disable Windows Interruptions Completely
      run: |
        Write-Host "ğŸš« Disabling all Windows interruptions..."
        
        # ØªØ¹Ø·ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
        $updateServices = @("wuauserv", "UsoSvc", "WaaSMedicSvc", "BITS", "DoSvc")
        foreach ($service in $updateServices) {
            Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
            Set-Service -Name $service -StartupType Disabled -ErrorAction SilentlyContinue
        }
        
        # ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§ÙØ¹ ÙˆÙ…Ø¶Ø§Ø¯ Ø§Ù„ÙÙŠØ±ÙˆØ³Ø§Øª
        $defenderServices = @("WinDefend", "WdNisSvc", "Sense", "SecurityHealthService")
        foreach ($service in $defenderServices) {
            Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
            Set-Service -Name $service -StartupType Disabled -ErrorAction SilentlyContinue
        }
        
        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" -Name "NoAutoUpdate" -Value 1 -Force -ErrorAction SilentlyContinue
        Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" -Name "NoAutoRebootWithLoggedOnUsers" -Value 1 -Force -ErrorAction SilentlyContinue
        Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" -Name "AUOptions" -Value 1 -Force -ErrorAction SilentlyContinue
        
        # ØªØ¹Ø·ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Notifications\Settings" -Name "NTS_GUI_SETTING" -Value 1 -Force -ErrorAction SilentlyContinue
        
        Write-Host "âœ… All Windows interruptions disabled"

    - name: Configure Network Stability
      run: |
        Write-Host "ğŸŒ Configuring network stability..."
        
        # ØªØ­Ø³ÙŠÙ† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª TCP
        netsh int tcp set global autotuninglevel=normal
        netsh int tcp set global rss=enabled
        netsh int tcp set global chimney=enabled
        
        # ØªØ¹Ø·ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø§Ù‚Ø© Ù„Ù„Ø´Ø¨ÙƒØ©
        $networkPaths = @(
            "HKLM:\SYSTEM\CurrentControlSet\Control\Class\{4d36e972-e325-11ce-bfc1-08002be10318}\0001",
            "HKLM:\SYSTEM\CurrentControlSet\Control\Class\{4d36e972-e325-11ce-bfc1-08002be10318}\0002"
        )
        
        foreach ($path in $networkPaths) {
            if (Test-Path $path) {
                Set-ItemProperty -Path $path -Name "PnPCapabilities" -Value 24 -Force -ErrorAction SilentlyContinue
                Set-ItemProperty -Path $path -Name "PowerManagement" -Value 0 -Force -ErrorAction SilentlyContinue
            }
        }
        
        Write-Host "âœ… Network stability configured"

    - name: Create Permanent Maintenance System
      run: |
        Write-Host "ğŸ”§ Creating permanent maintenance system..."
        
        $maintenanceScript = @'
# Permanent RDP Maintenance Script - 30 Days
param(
    [int]$TotalDays = 30,
    [int]$CheckInterval = 300  # 5 minutes
)

$logPath = "C:\rdp-permanent.log"
$startTime = Get-Date
$endTime = $startTime.AddDays($TotalDays)
$checkCount = 0

function Write-Log {
    param([string]$Message)
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logEntry = "[$timestamp] $Message"
    Add-Content -Path $logPath -Value $logEntry
}

function Test-RDPService {
    $service = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
    return $service.Status -eq "Running"
}

function Test-TailscaleConnection {
    try {
        $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 2>$null
        return [bool]$ip
    } catch {
        return $false
    }
}

Write-Log "=== PERMANENT RDP MAINTENANCE STARTED ==="
Write-Log "Start Time: $startTime"
Write-Log "End Time: $endTime"
Write-Log "Duration: $TotalDays days"

while ((Get-Date) -lt $endTime) {
    $currentTime = Get-Date
    $timeRemaining = $endTime - $currentTime
    $daysRemaining = [math]::Round($timeRemaining.TotalDays, 2)
    
    # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ Ø³Ø§Ø¹Ø©
    if ($checkCount % 12 -eq 0) {
        Write-Log "System Active - $daysRemaining days remaining"
    }
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø®Ø¯Ù…Ø§Øª RDP ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚
    if ($checkCount % 2 -eq 0) {
        if (-not (Test-RDPService)) {
            Write-Log "RDP Service stopped - Restarting..."
            Start-Service -Name "TermService" -Force
            Start-Sleep -Seconds 5
        }
    }
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Tailscale ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©
    if ($checkCount % 6 -eq 0) {
        if (-not (Test-TailscaleConnection)) {
            Write-Log "Tailscale disconnected - Reconnecting..."
            & "C:\Program Files\Tailscale\tailscale.exe" up --reset 2>$null
            Start-Sleep -Seconds 10
        }
    }
    
    # ØµÙŠØ§Ù†Ø© Ø´Ø§Ù…Ù„Ø© ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª
    if ($checkCount % 72 -eq 0) {
        Write-Log "Performing comprehensive maintenance..."
        
        # Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ù…Ù†ÙØ° RDP
        netsh advfirewall firewall delete rule name="RDP-Backup" 2>$null
        netsh advfirewall firewall add rule name="RDP-Backup" dir=in action=allow protocol=TCP localport=3389
        
        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        Clear-EventLog -LogName Application -ErrorAction SilentlyContinue
        
        Write-Log "Comprehensive maintenance completed"
    }
    
    $checkCount++
    Start-Sleep -Seconds $CheckInterval
}

Write-Log "=== 30-DAY RDP SESSION COMPLETED ==="
Write-Log "Completion Time: $(Get-Date)"
'@

        Set-Content -Path "C:\rdp-maintenance.ps1" -Value $maintenanceScript
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù‡Ù…Ø© Ù…Ø¬Ø¯ÙˆÙ„Ø© Ù„Ù„ØµÙŠØ§Ù†Ø©
        $action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-WindowStyle Hidden -File C:\rdp-maintenance.ps1 -TotalDays 30"
        $trigger = New-ScheduledTaskTrigger -AtStartup
        $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable -RunOnlyIfNetworkAvailable:$false
        Register-ScheduledTask -TaskName "PermanentRDPMaintenance" -Action $action -Trigger $trigger -Settings $settings -RunLevel Highest -Force
        
        Write-Host "âœ… Permanent maintenance system created"

    - name: Test RDP Connection
      run: |
        Write-Host "ğŸ” Testing RDP connection..."
        if ($env:RDP_IP) {
            $testResult = Test-NetConnection -ComputerName $env:RDP_IP -Port 3389 -InformationLevel Quiet -WarningAction SilentlyContinue
            if ($testResult) {
                Write-Host "âœ… RDP Connection Test: SUCCESS"
            } else {
                Write-Host "âš ï¸ RDP Connection Test: Port check failed but continuing..."
            }
        } else {
            Write-Host "â„¹ï¸ Skipping RDP test - No IP available"
        }

    - name: Start 30-Day Permanent Session
      run: |
        Write-Host ""
        Write-Host "========================================================"
        Write-Host "ğŸš€ PERMANENT RDP SERVER - 30 DAYS"
        Write-Host "========================================================"
        Write-Host "ğŸŒ IP Address: $env:RDP_IP"
        Write-Host "ğŸ‘¤ Username: $env:RDP_USER"
        Write-Host "ğŸ”‘ Password: $env:RDP_PASS"
        Write-Host ""
        Write-Host "â° Duration: 30 DAYS"
        Write-Host "ğŸ• Start Time: $(Get-Date)"
        Write-Host "ğŸ“… End Time: $((Get-Date).AddDays(30))"
        Write-Host "ğŸ”„ Auto-renewal: Every 5 hours"
        Write-Host ""
        Write-Host "ğŸ”’ Features:"
        Write-Host "  â€¢ 30 Days Continuous Operation"
        Write-Host "  â€¢ Static IP Address"
        Write-Host "  â€¢ Manual Authentication"
        Write-Host "  â€¢ No Timeouts"
        Write-Host "  â€¢ Auto-maintenance"
        Write-Host "  â€¢ No Interruptions"
        Write-Host "========================================================"
        Write-Host ""

        # Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙŠØ§Ù†Ø©
        Start-ScheduledTask -TaskName "PermanentRDPMaintenance"
        Start-Process PowerShell.exe -ArgumentList "-WindowStyle Hidden -File C:\rdp-maintenance.ps1 -TotalDays 30" -WindowStyle Hidden
        
        # Ø§Ù„Ø¨Ù‚Ø§Ø¡ Ù†Ø´Ø·Ø§Ù‹ Ù„Ù…Ø¯Ø© 5 Ø³Ø§Ø¹Ø§Øª Ùˆ50 Ø¯Ù‚ÙŠÙ‚Ø©
        $totalMinutes = 350
        $minutesElapsed = 0
        
        while ($minutesElapsed -lt $totalMinutes) {
            $remainingMinutes = $totalMinutes - $minutesElapsed
            $hours = [math]::Floor($remainingMinutes / 60)
            $minutes = $remainingMinutes % 60
            
            # Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©
            if ($minutesElapsed % 30 -eq 0) {
                Write-Host "[$(Get-Date)] Permanent RDP Active - $hours}h $minutes}m until renewal"
                
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª
                try {
                    if (Test-Path "C:\rdp-permanent.log") {
                        $lastLog = Get-Content "C:\rdp-permanent.log" -Tail 1 -ErrorAction SilentlyContinue
                        if ($lastLog) {
                            Write-Host "Maintenance Log: $lastLog"
                        }
                    }
                } catch {
                    # ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
                }
            }
            
            # ÙØ­Øµ ØµØ­Ø© Ø´Ø§Ù…Ù„ ÙƒÙ„ Ø³Ø§Ø¹Ø©
            if ($minutesElapsed % 60 -eq 0) {
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø®Ø¯Ù…Ø© RDP
                $rdpService = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
                if ($rdpService.Status -ne "Running") {
                    Write-Host "ğŸ”„ Restarting RDP Service..."
                    Start-Service -Name "TermService" -Force
                }
                
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Tailscale
                try {
                    $currentIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                    if ($currentIP -and $currentIP -eq $env:RDP_IP) {
                        Write-Host "âœ… Tailscale IP Stable: $currentIP"
                    } else {
                        Write-Host "ğŸ”„ Refreshing Tailscale connection..."
                        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --reset
                    }
                } catch {
                    Write-Host "âš ï¸ Tailscale check error"
                }
            }
            
            $minutesElapsed += 5
            Start-Sleep -Seconds 300  # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 5 Ø¯Ù‚Ø§Ø¦Ù‚
        }
        
        Write-Host "Session renewal in progress..."
