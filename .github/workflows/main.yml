name: RDP
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 28800

    steps:
    - name: Configure RDP Settings
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxConnectionTime" -Value 2147483647 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxDisconnectionTime" -Value 2147483647 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxIdleTime" -Value 2147483647 -Force
        netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
        Restart-Service -Name TermService -Force
        Write-Host "RDP configured successfully"

    - name: Disable Power Saving
      run: |
        powercfg /change standby-timeout-ac 0
        powercfg /change hibernate-timeout-ac 0
        powercfg /change monitor-timeout-ac 0
        powercfg /change disk-timeout-ac 0
        powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        Write-Host "Power saving disabled"

    - name: Create User Account
      run: |
        $username = "TOOLBOXLAP"
        $password = "admin@123"
        Remove-LocalUser -Name $username -ErrorAction SilentlyContinue
        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
        New-LocalUser -Name $username -Password $securePassword -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member $username
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
        Set-LocalUser -Name $username -PasswordNeverExpires $true
        Write-Host "User $username created successfully"
        echo "RDP_USER=$username" >> $env:GITHUB_ENV
        echo "RDP_PASS=$password" >> $env:GITHUB_ENV

    - name: Install Tailscale
      run: |
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
        Start-Process msiexec.exe -Wait -ArgumentList @("/i", "`"$installerPath`"", "/quiet", "/norestart")
        Remove-Item $installerPath -Force
        Start-Sleep -Seconds 15
        Write-Host "Tailscale installed successfully"

    - name: Setup Tailscale Connection
      run: |
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --hostname=github-rdp --accept-routes --accept-dns --reset
        Write-Host "Waiting for authentication..."
        $tsIP = $null
        for ($i = 1; $i -le 60; $i++) {
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            if ($tsIP) {
                echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
                Write-Host "Tailscale IP: $tsIP"
                break
            }
            Start-Sleep -Seconds 5
        }
        if (-not $tsIP) {
            Write-Host "Could not get IP immediately, continuing..."
            echo "TAILSCALE_IP=pending" >> $env:GITHUB_ENV
        }

    - name: Disable Windows Updates
      run: |
        Stop-Service -Name "wuauserv" -Force -ErrorAction SilentlyContinue
        Set-Service -Name "wuauserv" -StartupType Disabled -ErrorAction SilentlyContinue
        New-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" -Name "NoAutoUpdate" -Value 1 -PropertyType DWORD -Force -ErrorAction SilentlyContinue
        Write-Host "Windows updates disabled"

    - name: Test RDP Connection
      run: |
        if ($env:TAILSCALE_IP -and $env:TAILSCALE_IP -ne "pending") {
            Write-Host "Testing RDP connection to $env:TAILSCALE_IP"
            $connectionTest = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -InformationLevel Quiet
            if ($connectionTest) {
                Write-Host "RDP connection test: SUCCESS"
            } else {
                Write-Host "RDP connection test: FAILED - but continuing anyway"
            }
        } else {
            Write-Host "RDP connection test: SKIPPED - Waiting for authentication"
        }

    - name: Keep Alive for 30 Days
      run: |
        Write-Host ""
        Write-Host "=================================================="
        Write-Host "RDP ACCESS INFORMATION"
        Write-Host "=================================================="
        Write-Host "IP Address: $env:TAILSCALE_IP"
        Write-Host "Username: $env:RDP_USER"
        Write-Host "Password: $env:RDP_PASS"
        Write-Host ""
        Write-Host "Session Duration: 30 DAYS"
        Write-Host "Start Time: $(Get-Date)"
        Write-Host "End Time: $((Get-Date).AddDays(30))"
        Write-Host "=================================================="
        Write-Host ""

        $totalMinutes = 30 * 24 * 60
        $checkCount = 0
        
        for ($i = 0; $i -lt $totalMinutes; $i++) {
            $remainingDays = 30 - [math]::Round($i / (24 * 60), 1)
            
            if ($checkCount % 144 == 0) {
                Write-Host "[$(Get-Date)] RDP Active - $remainingDays days remaining"
            }
            
            if ($checkCount % 12 == 0) {
                $rdpService = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
                if ($rdpService.Status -ne "Running") {
                    Write-Host "RDP service not running - restarting..."
                    Start-Service -Name "TermService" -Force
                }
            }
            
            $checkCount++
            Start-Sleep -Seconds 60
        }
        
        Write-Host "30-day RDP session completed successfully!"
