name: RDP
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'  # يعيد التشغيل كل 5 ساعات

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 350  # 5 ساعات و50 دقيقة

    steps:
    - name: Configure Permanent RDP
      run: |
        Write-Host "Configuring Permanent RDP..."
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxConnectionTime" -Value 2147483647 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxDisconnectionTime" -Value 2147483647 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxIdleTime" -Value 2147483647 -Force
        netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
        Restart-Service -Name TermService -Force
        Write-Host "RDP configured successfully"

    - name: Disable Power Saving
      run: |
        powercfg /change standby-timeout-ac 0
        powercfg /change hibernate-timeout-ac 0
        powercfg /change monitor-timeout-ac 0
        powercfg /change disk-timeout-ac 0
        powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        Write-Host "Power saving disabled"

    - name: Create User Account
      run: |
        $username = "TOOLBOXLAP"
        $password = "admin@123"
        Remove-LocalUser -Name $username -ErrorAction SilentlyContinue
        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
        New-LocalUser -Name $username -Password $securePassword -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member $username
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
        Set-LocalUser -Name $username -PasswordNeverExpires $true
        Write-Host "User $username created successfully"
        echo "RDP_USER=$username" >> $env:GITHUB_ENV
        echo "RDP_PASS=$password" >> $env:GITHUB_ENV

    - name: Install Tailscale
      run: |
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
        Start-Process msiexec.exe -Wait -ArgumentList @("/i", "`"$installerPath`"", "/quiet", "/norestart")
        Remove-Item $installerPath -Force
        Start-Sleep -Seconds 15
        Write-Host "Tailscale installed successfully"

    - name: Setup Tailscale with Persistent Auth
      run: |
        # محاولة استخدام مصادقة موجودة مسبقاً
        Write-Host "Checking for existing Tailscale authentication..."
        $existingStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status 2>$null
        if ($LASTEXITCODE -eq 0) {
            Write-Host "Found existing Tailscale connection"
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            if ($tsIP) {
                echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
                Write-Host "Using existing Tailscale IP: $tsIP"
                exit 0
            }
        }
        
        # إذا لم توجد مصادقة موجودة، إنشاء جديدة
        Write-Host "Setting up new Tailscale connection..."
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --hostname=permanent-rdp-static --accept-routes --accept-dns --reset
        
        Write-Host "Waiting for authentication..."
        Write-Host "Please authenticate within 10 minutes..."
        
        $tsIP = $null
        for ($i = 1; $i -le 120; $i++) {
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            if ($tsIP) {
                echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
                Write-Host "Tailscale IP: $tsIP"
                
                # حفظ معلومات المصادقة
                & "$env:ProgramFiles\Tailscale\tailscale.exe" status > "C:\tailscale-status.txt" 2>$null
                break
            }
            if ($i % 10 -eq 0) {
                $remaining = 120 - $i
                Write-Host "Still waiting... $remaining seconds remaining"
            }
            Start-Sleep -Seconds 5
        }
        
        if (-not $tsIP) {
            Write-Host "Authentication timeout - Please run workflow again"
            exit 1
        }

    - name: Disable Windows Updates
      run: |
        Stop-Service -Name "wuauserv" -Force -ErrorAction SilentlyContinue
        Set-Service -Name "wuauserv" -StartupType Disabled -ErrorAction SilentlyContinue
        New-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" -Name "NoAutoUpdate" -Value 1 -PropertyType DWORD -Force -ErrorAction SilentlyContinue
        Write-Host "Windows updates disabled"

    - name: Create Auto-Restart System
      run: |
        # إنشاء سكريبت لإعادة التشغيل التلقائي
        $restartScript = @'
# Auto-Restart System for RDP
param($RestartTime = 350) # 5 hours 50 minutes in minutes

$startTime = Get-Date
$restartTime = $startTime.AddMinutes($RestartTime)
$checkInterval = 60 # 1 minute

Write-Host "Auto-Restart System Started at: $startTime"
Write-Host "Scheduled restart at: $restartTime"

while ((Get-Date) -lt $restartTime) {
    $remaining = $restartTime - (Get-Date)
    $minutes = [math]::Round($remaining.TotalMinutes, 0)
    
    # تسجيل الحالة كل 30 دقيقة
    if ($minutes % 30 -eq 0) {
        Write-Host "[$(Get-Date)] System Active - $minutes minutes until auto-restart"
    }
    
    # التحقق من الخدمات كل 15 دقيقة
    if ($minutes % 15 -eq 0) {
        # التحقق من RDP
        $rdpService = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
        if ($rdpService.Status -ne "Running") {
            Write-Host "Restarting RDP Service..."
            Start-Service -Name "TermService" -Force
        }
        
        # التحقق من Tailscale
        try {
            $currentIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
            if (-not $currentIP) {
                Write-Host "Reconnecting Tailscale..."
                & "C:\Program Files\Tailscale\tailscale.exe" up --reset
            }
        } catch {
            Write-Host "Tailscale check failed"
        }
    }
    
    Start-Sleep -Seconds $checkInterval
}

Write-Host "Auto-restart system completed at: $(Get-Date)"
'@
        Set-Content -Path "C:\auto-restart.ps1" -Value $restartScript
        Write-Host "Auto-restart system created"

    - name: Test RDP Connection
      run: |
        if ($env:TAILSCALE_IP) {
            Write-Host "Testing RDP connection to $env:TAILSCALE_IP"
            $connectionTest = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -InformationLevel Quiet
            if ($connectionTest) {
                Write-Host "RDP connection test: SUCCESS"
            } else {
                Write-Host "RDP connection test: FAILED - but continuing anyway"
            }
        } else {
            Write-Host "RDP connection test: SKIPPED - No IP available"
        }

    - name: Start Continuous Operation
      run: |
        Write-Host ""
        Write-Host "=================================================="
        Write-Host "PERMANENT RDP - CONTINUOUS OPERATION"
        Write-Host "=================================================="
        Write-Host "IP Address: $env:TAILSCALE_IP"
        Write-Host "Username: $env:RDP_USER"
        Write-Host "Password: $env:RDP_PASS"
        Write-Host ""
        Write-Host "Operation: CONTINUOUS"
        Write-Host "Auto-restart: Every 5 hours 50 minutes"
        Write-Host "Start Time: $(Get-Date)"
        Write-Host "Next Restart: $((Get-Date).AddMinutes(350))"
        Write-Host ""
        Write-Host "Features:"
        Write-Host "  • Continuous Operation"
        Write-Host "  • Static IP Address"
        Write-Host "  • One-Time Authentication"
        Write-Host "  • Auto-Restart System"
        Write-Host "=================================================="
        Write-Host ""

        # بدء نظام إعادة التشغيل التلقائي
        Start-Process PowerShell.exe -ArgumentList "-WindowStyle Hidden -File C:\auto-restart.ps1 -RestartTime 350" -WindowStyle Hidden

        # البقاء نشطاً لمدة 5 ساعات و50 دقيقة
        $totalMinutes = 350
        $minutesPassed = 0
        
        while ($minutesPassed -lt $totalMinutes) {
            $remainingMinutes = $totalMinutes - $minutesPassed
            $hours = [math]::Floor($remainingMinutes / 60)
            $minutes = $remainingMinutes % 60
            
            # عرض الحالة كل 30 دقيقة
            if ($minutesPassed % 30 -eq 0) {
                Write-Host "[$(Get-Date)] RDP Active - $hours hours $minutes minutes until auto-restart"
                
                # عرض IP الحالي للتأكد من ثباته
                $currentIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
                if ($currentIP) {
                    Write-Host "Current IP: $currentIP"
                }
            }
            
            # فحص صحة الخدمات كل 15 دقيقة
            if ($minutesPassed % 15 -eq 0) {
                # التحقق من خدمة RDP
                $rdpService = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
                if ($rdpService.Status -ne "Running") {
                    Write-Host "Ensuring RDP service is running..."
                    Start-Service -Name "TermService" -Force
                }
                
                # التحقق من استقرار Tailscale
                try {
                    $currentIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                    $originalIP = $env:TAILSCALE_IP
                    
                    if ($currentIP -and $originalIP -and $currentIP -eq $originalIP) {
                        Write-Host "IP Stability: CONFIRMED ($currentIP)"
                    } elseif ($currentIP) {
                        Write-Host "IP Changed: $currentIP (was: $originalIP)"
                        echo "TAILSCALE_IP=$currentIP" >> $env:GITHUB_ENV
                    } else {
                        Write-Host "Restoring Tailscale connection..."
                        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --hostname=permanent-rdp-static --reset
                    }
                } catch {
                    Write-Host "IP check error - continuing"
                }
            }
            
            $minutesPassed += 1
            Start-Sleep -Seconds 60
        }
        
        Write-Host "Auto-restart initiated..."
        Write-Host "New session will start automatically in 10 minutes"
